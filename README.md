# OPNsense OpenVPN Auto-Setup (API_OPN_VPN)

????????????????????????? PowerShell ???????????????????????? OpenVPN (Remote Access, User-Auth) ?? OPNsense Firewall ??????????????????? ?????? OPNsense API ???????? (??? SSH ???????????? API ????????)

??????????????????????????????????????????????????????????????????? ??????????????????????????????????????? ???????????????? VPN Server ????????????????????????????

---

## ?? Features (??????????????)

??????????? (`Run-Full-Setup.ps1`) ??????????? Pipeline 9 ???????????????????:

1.  **(Task 1) ????? Group:** ??????????????????? (???? "vpn-users")
2.  **(Task 2) ????? Users:** ????? User (???? alice, bob) ??????? `config.users.json` ???????????? Group
3.  **(Task 3) ????? CA:** ????? Certificate Authority (CA) ?????????? VPN
4.  **(Task 4) ????? Client Certs:** ????? Certificate ?????? User ????? (alice, bob)
5.  **(Task 5) ????? Server Cert:** ????? Certificate ?????? OpenVPN Server
6.  **(Task 6) ????? Static Key:** ????? `tls-crypt` key ?????????????????????
7.  **(Task 7) ????? Instance:** ????? OpenVPN Server Instance ???????????? Network (Tunnel, Local LAN)
8.  **(Task 8) Assign Interface (SSH):** ????????????? SSH ????????? Assign Interface `ovpnsX` ??????? `OPTx` (????????? API ???????????????)
9.  **(Task 9) ????? Firewall Rules:** ???? Port ??? WAN ???????? Rule ??? Interface OpenVPN (?????????????) ??????????? Traffic

---

## ?? How to Use (??????????)

1.  **Prerequisites:** ??????? Module `Posh-SSH` ?? PowerShell:
    ```powershell
    Install-Module -Name Posh-SSH -Scope CurrentUser
    ```

2.  **Configuration:**
    * **`config.profiles.json`:** (???????????) ??? API Key, Secret, ??????? SSH ??? OPNsense ????????????????????
    * **`config.settings.json`:** ???????????????? (???? `VpnTunnelNetwork`) ??? Port ??????????
    * **`config.users.json`:** ?????????? User ??????????????????????????

3.  **Step 1: Run Setup (??????????????):**
    * ?????????? `Run-Full-Setup.ps1` ???????? Profile ??????????
    * ?????????????????? 9 Task
    * ?????????? ?????????? (Cert, Keys) ?????????????????????? `output_data/PROFILE_NAME/`

4.  **Step 2: Build Clients (????????? .ovpn):**
    * ?????????? `Build-Ovpn-Files.ps1` (????????????????)
    * ????????????????????????????? `output_data/` ???????????????????? `.ovpn` ??????????????
    * ???? `.ovpn` (???? `alice.ovpn`, `bob.ovpn`) ?????????????? `output_data/PROFILE_NAME/_ovpn_files/`

---

## ??? ?????????? GUI (Python)

??????????????????? CLI ???????????? GUI ?????????????????? (`gui_app.py`) ?????????????????????????????????????????????????

1. **?????? Python 3.10+** ??????????????????????????? PowerShell scripts ??????????????? PowerShell (`pwsh` ?? macOS/Linux ???? `powershell.exe` ?? Windows)
2. **??????????????????????????** GUI ????????????????????????? Python
3. **???????????**
   ```bash
   python gui_app.py
   ```
4. ??????????????? ?????????:
   * ?????/?????/???????????? API + SSH ?????????? Profiles
   * ??????? `config.settings.json` ?????? Settings
   * ?????/??/???????????????? VPN ?????? Users
   * ?????? "Run Full Setup" ???? "Build OVPN Files" ?????? Actions & Logs ????????????????? PowerShell ????? log ????????????

GUI ???????????????????????????? JSON ???? ???????????????????????? PowerShell ?????????????????????????? CLI ????


## Profiles & Users (GUI)

The GUI now persists configuration in `config.gui.json` with dedicated collections for firewall
settings and user rosters:

```json
{
  "opnsense_profiles": [
    {
      "id": "opn-default",
      "name": "OPNsense-Default",
      "settings": {
        "connection": {
          "ApiBaseUrl": "https://firewall.example.com:4443",
          "ApiKey": "...",
          "ApiSecret": "...",
          "SshHost": "firewall.example.com",
          "SshUser": "root",
          "SshPass": ""
        },
        "automation": {
          "GroupName": "vpn-users",
          "VpnTunnelNetwork": "10.99.0.0/24",
          "Firewall": {
            "VpnListenPort": "1194",
            "VpnProto": "udp4"
          }
        }
      }
    }
  ],
  "user_profiles": [
    {
      "id": "usr-default",
      "name": "Users-Default",
      "users": [
        {
          "username": "alice",
          "password": "***",
          "full_name": "Alice (VPN User)",
          "email": "alice@example.com"
        }
      ]
    }
  ],
  "selected_opnsense_profile_id": "opn-default",
  "selected_user_profile_id": "usr-default"
}
```

Key behaviour in the GUI:

- **Profiles tab** manages OPNsense profiles (New, Rename, Duplicate, Delete). Duplicating an OPNsense
  profile deep-copies the settings and instantly selects the clone.
- **Settings tab** always mirrors the currently selected OPNsense profile. Fields are disabled if no
  OPNsense profile is available.
- **Users tab** manages user profiles separately from firewall settings. Each user profile owns its own
  roster of accounts (New, Duplicate, Delete, inline edit, validation). Duplicating a user profile
  deep-copies the contained users and ensures usernames stay unique via `-copy`, `-copy-2`, â€¦ suffixes.
- **Actions & Logs tab** now exposes two comboboxes: one for the OPNsense profile, one for the user profile.
  "Run Full Setup" uses the selected OPNsense profile; "Build OVPN Files" applies the selected user profile
  (gracefully skipping execution when it has zero users). Before each run the GUI exports the legacy
  `config.profiles/settings/users.json` files so the PowerShell pipeline continues to work.

When launching on top of a legacy single-profile schema the GUI automatically migrates each legacy profile
into an OPNsense profile plus a matching user profile, preserving the data and selections.
