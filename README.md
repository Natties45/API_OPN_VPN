# OPNsense OpenVPN Auto-Setup (API_OPN_VPN)

‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå PowerShell ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå OpenVPN (Remote Access, User-Auth) ‡∏ö‡∏ô OPNsense Firewall ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ OPNsense API ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏•‡∏∞ SSH ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà API ‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)

‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏¥‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á VPN Server ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥

---

## üöÄ Features (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏•‡∏±‡∏Å)

‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å (`Run-Full-Setup.ps1`) ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Pipeline 9 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏±‡∏ô:

1.  **(Task 1) ‡∏™‡∏£‡πâ‡∏≤‡∏á Group:** ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô "vpn-users")
2.  **(Task 2) ‡∏™‡∏£‡πâ‡∏≤‡∏á Users:** ‡∏™‡∏£‡πâ‡∏≤‡∏á User (‡πÄ‡∏ä‡πà‡∏ô alice, bob) ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå `config.users.json` ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Group
3.  **(Task 3) ‡∏™‡∏£‡πâ‡∏≤‡∏á CA:** ‡∏™‡∏£‡πâ‡∏≤‡∏á Certificate Authority (CA) ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö VPN
4.  **(Task 4) ‡∏™‡∏£‡πâ‡∏≤‡∏á Client Certs:** ‡∏™‡∏£‡πâ‡∏≤‡∏á Certificate ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö User ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (alice, bob)
5.  **(Task 5) ‡∏™‡∏£‡πâ‡∏≤‡∏á Server Cert:** ‡∏™‡∏£‡πâ‡∏≤‡∏á Certificate ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OpenVPN Server
6.  **(Task 6) ‡∏™‡∏£‡πâ‡∏≤‡∏á Static Key:** ‡∏™‡∏£‡πâ‡∏≤‡∏á `tls-crypt` key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
7.  **(Task 7) ‡∏™‡∏£‡πâ‡∏≤‡∏á Instance:** ‡∏™‡∏£‡πâ‡∏≤‡∏á OpenVPN Server Instance ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Network (Tunnel, Local LAN)
8.  **(Task 8) Assign Interface (SSH):** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô SSH ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á Assign Interface `ovpnsX` ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô `OPTx` (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å API ‡∏ó‡∏≥‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
9.  **(Task 9) ‡∏™‡∏£‡πâ‡∏≤‡∏á Firewall Rules:** ‡πÄ‡∏õ‡∏¥‡∏î Port ‡∏ó‡∏µ‡πà WAN ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Rule ‡∏ó‡∏µ‡πà Interface OpenVPN (‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Traffic

---

## üß∞ How to Use (‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)

1.  **Prerequisites:** ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Module `Posh-SSH` ‡∏ö‡∏ô PowerShell:
    ```powershell
    Install-Module -Name Posh-SSH -Scope CurrentUser
    ```

2.  **Configuration:**
    * **`config.profiles.json`:** (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) ‡πÉ‡∏™‡πà API Key, Secret, ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™ SSH ‡∏Ç‡∏≠‡∏á OPNsense ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    * **`config.settings.json`:** ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô `VpnTunnelNetwork`) ‡πÅ‡∏•‡∏∞ Port ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    * **`config.users.json`:** ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á

3.  **Step 1: Run Setup (‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å):**
    * ‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå `Run-Full-Setup.ps1` ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Profile ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    * ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 9 Task
    * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Cert, Keys) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `output_data/PROFILE_NAME/`

4.  **Step 2: Build Clients (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .ovpn):**
    * ‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå `Build-Ovpn-Files.ps1` (‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á)
    * ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å `output_data/` ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå `.ovpn` ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    * ‡πÑ‡∏ü‡∏•‡πå `.ovpn` (‡πÄ‡∏ä‡πà‡∏ô `alice.ovpn`, `bob.ovpn`) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô `output_data/PROFILE_NAME/_ovpn_files/`

---

## üñ•Ô∏è ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ö‡∏ö GUI (Python)

‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏ô‡∏±‡∏î CLI ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ GUI ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå (`gui_app.py`) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

1. **‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Python 3.10+** ‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô PowerShell scripts ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ PowerShell (`pwsh` ‡∏ö‡∏ô macOS/Linux ‡∏´‡∏£‡∏∑‡∏≠ `powershell.exe` ‡∏ö‡∏ô Windows)
2. **‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô** GUI ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Python
3. **‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô**
   ```bash
   python gui_app.py
   ```
4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ:
   * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå API + SSH ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö Profiles
   * ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ `config.settings.json` ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Settings
   * ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ VPN ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Users
   * ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚ÄúRun Full Setup‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚ÄúBuild OVPN Files‚Äù ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Actions & Logs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå PowerShell ‡πÅ‡∏•‡∏∞‡∏î‡∏π log ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå

GUI ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏î‡∏¥‡∏° ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå PowerShell ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô CLI ‡∏Ñ‡∏£‡∏±‡∏ö


## Profiles & Users (GUI)

The GUI now keeps a single configuration file `config.gui.json` that contains the active profile id together with the full list of profiles. Each profile owns its API/SSH connection data, automation settings, and users. A simplified example of the schema is shown below:

```json
{
  "active_profile_id": "default",
  "profiles": [
    {
      "id": "default",
      "name": "Default",
      "settings": {
        "connection": {
          "ApiBaseUrl": "https://firewall.example.com:4443",
          "ApiKey": "...",
          "ApiSecret": "...",
          "SshHost": "firewall.example.com",
          "SshUser": "root",
          "SshPass": ""
        },
        "automation": {
          "GroupName": "vpn-users",
          "VpnTunnelNetwork": "10.99.0.0/24",
          "Firewall": {
            "VpnListenPort": "1194",
            "VpnProto": "udp4"
          }
        }
      },
      "users": [
        {
          "username": "alice",
          "password": "***",
          "full_name": "Alice (VPN User)",
          "email": "alice@example.com"
        }
      ]
    }
  ]
}
```

Selecting a profile in the GUI automatically makes it the active profile, so the drop-down on the Actions tab and the legacy export stay in sync.

When the PowerShell scripts are launched from the GUI, the manager exports legacy files (`config.profiles.json`, `config.settings.json`, `config.users.json`) for the selected profile so existing automation continues to work unchanged.
